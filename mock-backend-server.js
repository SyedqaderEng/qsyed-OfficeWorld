#!/usr/bin/env node
/**
 * Mock Backend Server for Testing PDF to Word Workflow
 *
 * This simple Express server simulates the backend API endpoints
 * needed for testing the complete PDF to Word conversion workflow.
 *
 * Run with: node mock-backend-server.js
 */

const express = require('express');
const cors = require('cors');
const multer = require('multer');
const { v4: uuidv4 } = require('uuid');

const app = express();
const upload = multer({ dest: 'uploads/' });

// Enable CORS
app.use(cors({
  origin: ['http://localhost:3002', 'http://localhost:3001'],
  credentials: true,
  methods: ['GET', 'POST', 'PUT', 'DELETE', 'OPTIONS'],
  allowedHeaders: ['Content-Type', 'Authorization']
}));

app.use(express.json());

// In-memory storage for mock data
const jobs = new Map();
const files = new Map();

console.log('\nðŸš€ Mock Backend Server Starting...\n');

// ==================== ENDPOINTS ====================

// Health Check
app.get('/api/health', (req, res) => {
  res.json({
    status: 'healthy',
    timestamp: new Date().toISOString(),
    uptime: process.uptime()
  });
});

// Upload File
app.post('/api/upload', upload.single('file'), (req, res) => {
  const fileId = uuidv4();
  const file = req.file;

  console.log(`\nðŸ“¤ UPLOAD REQUEST`);
  console.log(`   File: ${file.originalname}`);
  console.log(`   Size: ${(file.size / 1024).toFixed(2)} KB`);
  console.log(`   Generated File ID: ${fileId}`);

  files.set(fileId, {
    fileId,
    originalName: file.originalname,
    mimeType: file.mimetype,
    size: file.size,
    path: file.path,
    uploadedAt: new Date().toISOString()
  });

  res.json({
    success: true,
    data: {
      fileId,
      originalName: file.originalname,
      mimeType: file.mimetype,
      size: file.size,
      uploadedAt: new Date().toISOString()
    }
  });
});

// Process File (Start Conversion)
app.post('/api/process', (req, res) => {
  const { fileId, tool, options } = req.body;
  const requestId = uuidv4();
  const outputFileToken = uuidv4();

  console.log(`\nðŸ”§ PROCESS REQUEST`);
  console.log(`   File ID: ${fileId}`);
  console.log(`   Tool: ${tool}`);
  console.log(`   Options:`, JSON.stringify(options, null, 2));
  console.log(`   Generated Request ID: ${requestId}`);

  // Create job with initial state
  jobs.set(requestId, {
    requestId,
    fileId,
    tool,
    options,
    state: 'queued',
    progress: 0,
    message: 'Job queued for processing',
    outputFileToken,
    createdAt: Date.now(),
    startedAt: Date.now()
  });

  // Simulate state progression in background
  simulateProcessing(requestId);

  res.json({
    success: true,
    data: {
      requestId
    },
    message: 'Processing job created successfully'
  });
});

// Get Job Status
app.get('/api/status/:requestId', (req, res) => {
  const { requestId } = req.params;
  const job = jobs.get(requestId);

  if (!job) {
    console.log(`\nâŒ STATUS CHECK - Job not found: ${requestId}`);
    return res.status(404).json({
      success: false,
      error: 'Job not found'
    });
  }

  console.log(`\nðŸ“Š STATUS CHECK`);
  console.log(`   Request ID: ${requestId}`);
  console.log(`   State: ${job.state}`);
  console.log(`   Progress: ${job.progress}%`);
  console.log(`   Message: ${job.message}`);

  res.json({
    success: true,
    data: {
      requestId: job.requestId,
      state: job.state,
      progress: job.progress,
      message: job.message,
      outputFileToken: job.state === 'done' ? job.outputFileToken : undefined,
      error: job.state === 'failed' ? job.error : undefined
    }
  });
});

// Download Converted File
app.get('/api/download/:fileToken', (req, res) => {
  const { fileToken } = req.params;

  console.log(`\nðŸ“¥ DOWNLOAD REQUEST`);
  console.log(`   File Token: ${fileToken}`);

  // Create a simple mock DOCX file (plain text for demo)
  const mockContent = `Mock Converted Document

This is a simulated Word document generated by the mock backend server.

Original File Token: ${fileToken}
Generated At: ${new Date().toISOString()}

In production, this would be the actual converted Word document.
`;

  res.setHeader('Content-Type', 'application/vnd.openxmlformats-officedocument.wordprocessingml.document');
  res.setHeader('Content-Disposition', 'attachment; filename="converted.docx"');
  res.send(Buffer.from(mockContent));

  console.log(`   âœ… Download complete!`);
});

// ==================== SIMULATION LOGIC ====================

function simulateProcessing(requestId) {
  const job = jobs.get(requestId);
  if (!job) return;

  const states = [
    { state: 'queued', progress: 0, message: 'Job queued for processing', delay: 1000 },
    { state: 'processing', progress: 20, message: 'Starting PDF processing', delay: 2000 },
    { state: 'ocr', progress: 40, message: 'Performing OCR text extraction', delay: 3000 },
    { state: 'converting', progress: 70, message: 'Converting to Word format', delay: 2500 },
    { state: 'finalizing', progress: 90, message: 'Finalizing document', delay: 1500 },
    { state: 'done', progress: 100, message: 'Conversion complete!', delay: 0 }
  ];

  let currentIndex = 0;

  function updateState() {
    if (currentIndex >= states.length) return;

    const stateData = states[currentIndex];
    job.state = stateData.state;
    job.progress = stateData.progress;
    job.message = stateData.message;

    console.log(`\nðŸ”„ STATE UPDATE`);
    console.log(`   Request ID: ${requestId}`);
    console.log(`   New State: ${job.state} (${job.progress}%)`);
    console.log(`   Message: ${job.message}`);

    currentIndex++;

    if (currentIndex < states.length) {
      setTimeout(updateState, stateData.delay);
    } else {
      console.log(`\nâœ… JOB COMPLETE: ${requestId}`);
    }
  }

  // Start state progression after initial delay
  setTimeout(updateState, 1000);
}

// ==================== START SERVER ====================

const PORT = 3000;

app.listen(PORT, () => {
  console.log(`âœ… Mock Backend Server Running!\n`);
  console.log(`   URL: http://localhost:${PORT}`);
  console.log(`   Health Check: http://localhost:${PORT}/api/health\n`);
  console.log(`ðŸ“ Available Endpoints:`);
  console.log(`   POST   /api/upload`);
  console.log(`   POST   /api/process`);
  console.log(`   GET    /api/status/:requestId`);
  console.log(`   GET    /api/download/:fileToken`);
  console.log(`   GET    /api/health\n`);
  console.log(`ðŸŽ¯ Ready to test PDF to Word conversion!\n`);
  console.log(`   Frontend: http://localhost:3002/tools/pdf-to-word-complete\n`);
});

// Graceful shutdown
process.on('SIGINT', () => {
  console.log('\n\nðŸ‘‹ Shutting down mock server...');
  process.exit(0);
});
